<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      .hidden {
        display: none;
      }
      .selection {
        display: flex;
        flex-direction: row;
        justify-content: center;
      }
      .selection > button,
      .options > button {
        background-color: rgba(120, 196, 240, 0.849);
        padding: 1% 3%;
        margin: 1% 2%;
        border-radius: 30px;
        border: none;
        cursor: pointer;
      }
      .options > button {
        margin-top: 10px;
      }
      .card {
        position: fixed;
        bottom: 5%;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 15%;
        background-color: aliceblue;
        padding: 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        z-index: 10;
      }
      .character {
        width: 50%;
      }
      .namecard {
        color: rgb(129, 179, 223);
      }
      .options {
        display: flex;
        justify-content: flex-end;
      }
      .dialogue-box {
        left: 50%;
      }
      @media (max-width: 1280px) {
        .card {
          height: 21%;
        }
        .options > button {
          margin: 0;
        }
      }
      @media (max-width: 1024px) {
        .card {
          height: 25%;
        }
      }
      @media (max-width: 924px) {
        .card {
          height: 17%;
        }
        .selection {
          margin-top: 4%;
        }
        .selection > button {
          padding: 2% 3%;
        }
      }
      @media (max-width: 768px) {
        .selection > button {
          padding: 2%;
        }
      }
      @media (max-width: 576px) {
        .card {
          height: 28%;
        }
        .selection {
          flex-direction: column;
        }
      }
      @media (max-width: 440px) {
        .card {
          height: 26%;
        }
        .options > button {
          padding: 5%;
        }
      }
      @media (max-width: 400px) {
        .card {
          height: 30%;
        }
        .options > button {
          padding: 3%;
        }
        .selection > button {
          margin: 4%;
        }
      }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: assets/targets.mind; filterMinCF:0.0001; filterBeta: 0.001" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="near: 10; far: 30000; objects: .clickable"></a-camera>
      <a-entity target id="targetA" mindar-image-target="targetIndex: 0" rotation="75 0 0"></a-entity>
      <div id="card_1" class="card hidden clickable">
        <div id="mrju" style="background-image: url('assets/mrju.png'); height: 500px; width: 470px;"></div>
        <div id="scene1" class="hidden">
          <h3 class="namecard">導覽員-小朱</h3>
          <h3 class="dialog">你好，我是小朱，接下來讓我為你解說門口這些美麗的陶片吧</h3>
          <div class="options">
            <button class="next-btn" data-next="card_2">請點選按鈕繼續</button>
          </div>
        </div>
      </div>
      <div id="card_2" class="card hidden">
        <div id="scene2">
          <h3 class="dialog">你來猜猜看牆面上的陶片尺寸是多少吧？</h3>
          <div class="selection">
            <button id="optionA" data-message="正確答案是10x20公分，你答對了嗎？" data-next="card_3">A.冰掌(兵長)一米六</button>
            <button id="optionB" data-message="答對了！你好棒" data-next="card_3">B.10×20公分</button>
            <button id="optionC" data-message="正確答案是10x20公分，你答對了嗎？" data-next="card_3">C.18×6公分</button>
          </div>
        </div>
      </div>
      <div id="card_3" class="card hidden">
        <div id="scene3">
          <h3 class="dialog" id="message"></h3>
          <div class="options">
            <button class="next-btn" data-next="card_4">請點選按鈕繼續</button>
          </div>
        </div>
      </div>
      <div id="card_4" class="card hidden">
        <div id="mrju" style="background-image: url('assets/mrju.png'); height: 500px; width: 470px;"></div>
        <div id="scene4">
          <h3 class="namecard">導覽員-小朱</h3>
          <h3 class="dialog">這些陶片的尺寸為10×20公分，剛上釉料時是無法看到色彩的，要等燒製完成後，顏色才會顯現出來，所以製作陶藝，就是一場藝術冒險哦。</h3>
          <div class="options">
            <button class="next-btn" data-next="card_5">請點選按鈕繼續</button>
          </div>
        </div>
      </div>
      <div id="card_5" class="card hidden">
        <div id="mrju" style="background-image: url('assets/mrju.png'); height: 500px; width: 470px;"></div>
        <div id="scene5">
          <h3 class="namecard">導覽員-小朱</h3>
          <h3 class="dialog">陶片的製作過程非常有趣...</h3>
          <div class="options">
            <button class="next-btn" data-next="card_6">請點選按鈕繼續</button>
          </div>
        </div>
      </div>
      <!-- More cards can be added similarly -->
    </a-scene>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let audioContext;
        let sourceNode;

        const resumeAudioContext = async () => {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          await audioContext.resume();
        };

        const getAudio = async (url) => {
          const response = await fetch(url);
          return await response.arrayBuffer();
        };

        const playMusic = async (url) => {
          if (!audioContext) await resumeAudioContext();
          const audioBuffer = await getAudio(url);
          const decodedData = await audioContext.decodeAudioData(audioBuffer);
          sourceNode = audioContext.createBufferSource();
          sourceNode.buffer = decodedData;
          sourceNode.connect(audioContext.destination);
          sourceNode.start();
        };

        const pauseMusic = () => {
          if (sourceNode) sourceNode.stop();
        };

        const sceneEl = document.querySelector('a-scene');
        let arSystem;

        sceneEl.addEventListener('loaded', () => {
          arSystem = sceneEl.systems["mindar-image-system"];

          const targets = [
            { id: 'targetA', sceneId: 'scene1', cardId: 'card_1', music: 'assets/1-3.wav' },
            { id: 'targetB', sceneId: 'scene5', cardId: 'card_5', music: 'assets/2.wav' },
            { id: 'targetC', sceneId: 'scene9', cardId: 'card_9', music: 'assets/3.wav' }
          ];

          targets.forEach(({ id, sceneId, cardId, music }) => {
            const target = document.getElementById(id);
            const card = document.getElementById(cardId);
            const scene = document.getElementById(sceneId);

            target.addEventListener('targetFound', () => {
              card.classList.remove('hidden');
              scene.classList.remove('hidden');
              playMusic(music);
            });

            target.addEventListener('targetLost', () => {
              card.classList.add('hidden');
              scene.classList.add('hidden');
              pauseMusic();
            });
          });

          const nextBtns = document.querySelectorAll('.next-btn');
          nextBtns.forEach((btn) => {
            btn.addEventListener('click', () => {
              const nextCardId = btn.dataset.next;
              document.getElementById(nextCardId).classList.remove('hidden');
              btn.closest('.card').classList.add('hidden');
            });
          });

          const options = document.querySelectorAll('.selection button');
          options.forEach((option) => {
            option.addEventListener('click', () => {
              const message = option.dataset.message;
              const nextCardId = option.dataset.next;
              document.getElementById('message').innerText = message;
              document.getElementById(nextCardId).classList.remove('hidden');
              option.closest('.card').classList.add('hidden');
            });
          });
        });
      });
    </script>
  </body>
</html>
