<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Interaction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.css">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        .hidden {
            display: none;
        }

        .dialog {
            position: absolute;
            top: 10%;
            left: 10%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .selection {
            position: absolute;
            top: 20%;
            left: 10%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }

        .selection button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a-scene mindar-image="imageTargetSrc: assets/targets.mind; filterMinCF:0.0001; filterBeta: 0.001" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <img id="mrju-preview" src="./assets/mrju.png" />
            <img id="hua-preview" src="./assets/hua.png" />
        </a-assets>
        <a-camera position="0 0 0" look-controls="enabled:false" cursor="fuse: false; rayOrigin: mouse;" raycaster="near: 10; far: 30000; objects: .clickable"></a-camera>
        <!-- Add AR Targets and Cards Here -->
        <a-entity target id="targetA" mindar-image-target="targetIndex: 0" rotation="75 0 0">
            <a-entity id="card_1" class="hidden clickable">
                <a-entity id="scene1" class="hidden">
                    <a-image id="mrju" src="#mrju-preview" alpha-test="0.5" position="0 0 0" height="0.552" width="1"></a-image>
                    <h3 class="dialog">你好啊，我是小朱，接下來讓我為你解說門口這些美麗的陶片吧</h3>
                </a-entity>
            </a-entity>
            <a-entity id="card_2" class="hidden">
                <a-entity id="scene2">
                    <a-image id="hua" src="#hua-preview" alpha-test="0.5" position="0 0 0" height="0.552" width="1"></a-image>
                    <h3 class="dialog">你來猜猜看牆面上的陶片尺寸是多少吧？</h3>
                    <div class="selection" style="display: flex; flex-direction: column;">
                        <button id="optionA">A.冰掌(兵長)一米六</button>
                        <button id="optionB">B.10×20公分</button>
                        <button id="optionC">C.18×6公分</button>
                    </div>
                </a-entity>
            </a-entity>
            <div id="card_3" class="hidden">
                <div id="scene3">
                    <h3 class="dialog">這些陶片的尺寸為10×20公分，剛上釉料時是無法看到色彩的，要等燒製完成後，顏色才會顯現出來，所以製作陶藝，就是一場藝術冒險哦。</h3>
                </div>
            </div>
            <div id="card_4" class="hidden">
                <div id="scene4">
                    <h3 class="dialog">而且每塊陶片都是由三到五位師傅共同創造出來的，他們在創作過程中互相合作，是非常有默契的藝術家團隊。等到陶片都燒製完成後，再固定在牆上，這些陶片的尺寸雖小，但背後蘊含著師傅們的心血和努力。</h3>
                </div>
            </div>
        </a-entity>
    </a-scene>
    <script>
        let audioContext;
        let sourceNode;

        const resumeAudioContext = async () => {
            console.log('Resuming AudioContext');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            await audioContext.resume();
            console.log('AudioContext resumed');
        };

        const getAudio = async (url) => {
            console.log(`Fetching audio from ${url}`);
            const response = await fetch(url);
            const buffer = await response.arrayBuffer();
            return buffer;
        };

        const playMusic = async (url) => {
            if (!audioContext) {
                await resumeAudioContext();
            }
            const audioBuffer = await getAudio(url);
            const decodedData = await audioContext.decodeAudioData(audioBuffer);
            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = decodedData;
            sourceNode.connect(audioContext.destination);
            sourceNode.start();
            console.log('Music started');
        };

        const pauseMusic = () => {
            if (sourceNode) {
                sourceNode.stop();
                console.log('Music stopped');
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            const sceneEl = document.querySelector('a-scene');
            let arSystem;

            sceneEl.addEventListener('loaded', function () {
                console.log('AR scene loaded');
                arSystem = sceneEl.systems["mindar-image-system"];

                const targets = [
                    { id: 'targetA', sceneId: 'scene1', cardId: 'card_1', music: 'assets/1-3.wav' },
                    { id: 'targetB', sceneId: 'scene5', cardId: 'card_5', music: 'assets/2.wav' },
                    { id: 'targetC', sceneId: 'scene9', cardId: 'card_9', music: 'assets/3.wav' },
                    { id: 'targetD', sceneId: 'scene14', cardId: 'card_14', music: 'assets/4.wav' },
                    { id: 'targetE', sceneId: 'scene19', cardId: 'card_19', music: null }
                ];

                targets.forEach(target => {
                    const { id, sceneId, cardId, music } = target;
                    const targetElement = document.querySelector(`#${id}`);
                    const sceneElement = document.getElementById(sceneId);
                    const cardElement = document.getElementById(cardId);

                    targetElement.addEventListener("targetFound", async event => {
                        console.log('target found');
                        sceneElement.classList.remove('hidden');
                        cardElement.classList.remove('hidden');
                        if (music) await playMusic(music);
                    });

                    targetElement.addEventListener("targetLost", event => {
                        console.log('target lost');
                        cardElement.classList.add('hidden');
                        sceneElement.classList.add('hidden');
                        if (music) pauseMusic();
                    });
                });

                // General function to handle card clicks
                const handleCardClick = (currentCard, currentScene, nextCard, nextScene, music) => {
                    console.log(`${currentCard.id} clicked`);
                    currentCard.classList.add('hidden');
                    currentScene.classList.add('hidden');
                    pauseMusic();
                    if (nextCard && nextScene) {
                        nextCard.classList.remove('hidden');
                        nextScene.classList.remove('hidden');
                        if (music) playMusic(music);
                    }
                };

                // Array of card sequences
                const cards = [
                    { currentCard: 'card_1', currentScene: 'scene1', nextCard: 'card_2', nextScene: 'scene2', music: null },
                    { currentCard: 'card_2', currentScene: 'scene2', nextCard: 'card_3', nextScene: 'scene3', music: 'assets/1-4.wav' },
                    { currentCard: 'card_3', currentScene: 'scene3', nextCard: 'card_4', nextScene: 'scene4', music: 'assets/1-5.wav' },
                    { currentCard: 'card_4', currentScene: 'scene4', nextCard: null, nextScene: null, music: null },
                    { currentCard: 'card_5', currentScene: 'scene5', nextCard: 'card_6', nextScene: 'scene6', music: 'assets/2-2.wav' },
                    { currentCard: 'card_6', currentScene: 'scene6', nextCard: 'card_7', nextScene: 'scene7', music: null },
                    { currentCard: 'card_7', currentScene: 'scene7', nextCard: 'card_8', nextScene: 'scene8', music: 'assets/2-4.wav' },
                    { currentCard: 'card_8', currentScene: 'scene8', nextCard: null, nextScene: null, music: null },
                    { currentCard: 'card_9', currentScene: 'scene9', nextCard: 'card_10', nextScene: 'scene10', music: null },
                    { currentCard: 'card_10', currentScene: 'scene10', nextCard: 'card_11', nextScene: 'scene11', music: null },
                    { currentCard: 'card_11', currentScene: 'scene11', nextCard: 'card_12', nextScene: 'scene12', music: 'assets/3-3.wav' },
                    { currentCard: 'card_12', currentScene: 'scene12', nextCard: 'card_13', nextScene: 'scene13', music: 'assets/3-4.wav' },
                    { currentCard: 'card_13', currentScene: 'scene13', nextCard: null, nextScene: null, music: null },
                    { currentCard: 'card_14', currentScene: 'scene14', nextCard: 'card_15', nextScene: 'scene15', music: null },
                    { currentCard: 'card_15', currentScene: 'scene15', nextCard: 'card_16', nextScene: 'scene16', music: null },
                    { currentCard: 'card_16', currentScene: 'scene16', nextCard: 'card_17', nextScene: 'scene17', music: null },
                    { currentCard: 'card_17', currentScene: 'scene17', nextCard: 'card_18', nextScene: 'scene18', music: 'assets/4-5.wav' },
                    { currentCard: 'card_18', currentScene: 'scene18', nextCard: null, nextScene: null, music: null },
                    { currentCard: 'card_19', currentScene: 'scene19', nextCard: 'card_20', nextScene: 'scene20', music: null },
                    { currentCard: 'card_20', currentScene: 'scene20', nextCard: null, nextScene: null, music: null }
                ];

                cards.forEach(card => {
                    const currentCardElement = document.getElementById(card.currentCard);
                    const currentSceneElement = document.getElementById(card.currentScene);
                    const nextCardElement = card.nextCard ? document.getElementById(card.nextCard) : null;
                    const nextSceneElement = card.nextScene ? document.getElementById(card.nextScene) : null;

                    currentCardElement.addEventListener('click', () => handleCardClick(currentCardElement, currentSceneElement, nextCardElement, nextSceneElement, card.music));
                });
            });
        });
    </script>
</body>
</html>
